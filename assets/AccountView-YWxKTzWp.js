import{_ as X,u as Z,a as $,r as d,c as V,o as ee,w as oe,b as B,d as o,e as l,f as i,g as t,h as g,i as z,v as E,j as R,n as ae,k as q,l as le,F as se,m as te,p as w,q as ne,t as re,M as c,s as A,x as ie}from"./index-BlQcYuVy.js";const ue={class:"page_wrapper"},de={class:"card_box"},ce={class:"avatar_area"},me={class:"upload-dialog-content"},pe={class:"uploaded-image-preview"},ve=["src"],fe={class:"upload-button-wrapper"},ge={class:"dialog-footer"},_e={class:"form_area"},he={__name:"AccountView",setup(be){const I=Z(),m=$(),n=d([]),_=d(!1),k=d(null),p=d(!1),v=d(null),L=a=>{try{const e=a?.[0].file;if(!e){c.error("No file selected");return}if(!e.type||!/^image\//.test(e.type)){c.error("You can only upload image files!");return}if(!e.size||e.size/1024/1024>=2){c.error("Image must be smaller than 2MB!");return}v.value=null,n.value=a}catch{c.error("Failed to process the selected file")}},M=async a=>{if(console.log("handleUploadSuccess",a),v.value=a.response,_.value=!1,v.value){const e={userId:m.info?.userId,photo:v.value.fileName},{code:h,msg:b}=await A(e).catch(y=>{c.error(y.msg)});h===0&&(c.success(b),m.info.accessUrl=a.response.accessUrl,p.value=!1,n.value=[])}},D=a=>{_.value=!1,c.error("Failed to upload image")},F=()=>(n.value[0]?.url&&URL.revokeObjectURL(n.value[0].url),n.value=[],!0),P=()=>{p.value=!0},j=()=>{if(n.value.length===0){c.error("Please select an image first");return}_.value=!0,k.value.submit()},O=V(()=>m.info?.accessUrl||""),u=d(!1),T=V(()=>u.value?{name:[{required:!0,trigger:["onBlur","onChange"],message:"Nickname is required"}],schoolCode:[{required:!0,trigger:["onBlur","onChange"],message:"School Name is required"}],schoolName:[{required:!0,trigger:["onBlur","onChange"],message:"School Name is required"}]}:{}),r=d({});function U(a=m.info){console.log("updateForm",a),r.value={name:a?.name,schoolCode:a?.schoolCode,schoolName:a?.schoolName}}ee(()=>{console.log("account mounted"),U()}),oe(()=>m.info,a=>{console.log("userStore.info changed"),U(a)});const N=d(!1),x=ne(async function(){if(console.log("handleBtnClicked",u.value),!u.value){u.value=!u.value;return}N.value=!0;const a={userId:m.info?.userId,name:r.value.name,schoolCode:r.value.schoolCode,schoolName:r.value.schoolName},e=await A(a).finally(()=>{N.value=!1,u.value=!u.value});console.log(e),e.code===0&&ie.success(e.msg)});return(a,e)=>{const h=i("a-avatar"),b=i("icon-delete"),y=i("a-button"),Y=i("a-upload"),G=i("a-modal"),S=i("t-input"),C=i("t-form-item"),f=i("t-col"),H=i("t-option"),J=i("t-select"),K=i("t-row"),Q=i("t-form");return g(),B("div",ue,[o("div",de,[e[9]||(e[9]=o("div",{class:"title"},"Edit personal profile",-1)),e[10]||(e[10]=o("div",{class:"text"}," Update your personal information to help other users better understand you ",-1)),o("section",ce,[o("div",{class:"avatar_container",onClick:P},[l(h,{size:140,"image-url":O.value},null,8,["image-url"]),e[6]||(e[6]=o("div",{class:"avatar_overlay"},[o("i",{class:"icon-edit"}),o("span",null,"Edit")],-1))]),l(G,{visible:p.value,"onUpdate:visible":e[1]||(e[1]=s=>p.value=s),title:"Upload Avatar",footer:!1,"mask-closable":!1,width:"500px"},{default:t(()=>[o("div",me,[z(o("div",pe,[o("img",{src:n.value[0]?n.value[0].url:"",alt:"Avatar preview",class:"avatar-preview"},null,8,ve),l(y,{class:"remove-button",status:"danger",shape:"circle",size:"large",style:{scale:"1.3"},onClick:F},{icon:t(()=>[l(b)]),_:1})],512),[[E,n.value.length>0]]),z(o("div",fe,[l(Y,{ref_key:"uploadRef",ref:k,"file-list":n.value,"list-type":"picture-card","image-preview":"",limit:1,draggable:"",action:"/backendAPI/sys/oss/s3/upload",accept:"image/*","auto-upload":!1,"show-file-list":!1,onChange:L,onSuccess:M,onError:D,onProgress:e[0]||(e[0]=s=>console.log("Upload progress:",s))},{"upload-button":t(()=>e[7]||(e[7]=[o("div",{style:{"background-color":"var(--color-fill-2)",color:"var(--color-text-1)",border:"1px dashed var(--color-fill-4)",height:"200px",width:"200px","border-radius":"2",display:"flex","justify-content":"center","align-items":"center"}},[o("div",{style:{"text-align":"center"}},[R(" Drag the file here "),o("br"),R(" or "),o("br"),o("span",{style:{color:"#3370ff"}}," Click to upload")])],-1)])),_:1},8,["file-list"])],512),[[E,n.value.length===0]]),e[8]||(e[8]=o("div",{class:"upload-tip"},"Max file size: 5MB",-1)),o("div",ge,[o("div",{class:ae(["dialog_main_btn",{disabled:n.value.length===0}]),onClick:j}," Confirm ",2)])])]),_:1},8,["visible"])]),o("section",_e,[l(Q,{ref:"formRef",labelAlign:"top",rules:T.value,data:r.value},{default:t(()=>[l(K,{gutter:[40,20]},{default:t(()=>[l(f,{span:4},{default:t(()=>[l(C,{label:"Nickname",name:"name"},{default:t(()=>[l(S,{modelValue:r.value.name,"onUpdate:modelValue":e[2]||(e[2]=s=>r.value.name=s),placeholder:"Enter your nickname",size:"large",disabled:!u.value,style:{width:"100%"}},null,8,["modelValue","disabled"])]),_:1})]),_:1}),l(f,{span:4},{default:t(()=>[l(C,{label:"School",name:"schoolCode"},{default:t(()=>[l(J,{modelValue:r.value.schoolCode,"onUpdate:modelValue":e[3]||(e[3]=s=>r.value.schoolCode=s),filterable:"",size:"large",disabled:!u.value},{default:t(()=>[(g(!0),B(se,null,te(w(I).schoolList,(s,W)=>(g(),q(H,{key:W,label:s.dictName,value:s.dictCode},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1}),r.value.schoolCode==="0"?(g(),q(f,{key:0,span:4},{default:t(()=>[l(C,{label:"School Name",name:"schoolName"},{default:t(()=>[l(S,{modelValue:r.value.schoolName,"onUpdate:modelValue":e[4]||(e[4]=s=>r.value.schoolName=s),placeholder:"Enter your school name",size:"large",disabled:!u.value,style:{width:"100%"}},null,8,["modelValue","disabled"])]),_:1})]),_:1})):le("",!0),l(f,{span:12},{default:t(()=>[o("div",{class:"dialog_main_btn",onClick:e[5]||(e[5]=(...s)=>w(x)&&w(x)(...s))},re(u.value?"Save":"Edit"),1)]),_:1})]),_:1})]),_:1},8,["rules","data"])])])])}}},Ce=X(he,[["__scopeId","data-v-d92e6b97"]]);export{Ce as default};
